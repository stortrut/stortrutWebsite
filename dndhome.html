<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zoomable Timeline Fixed</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f5f5f5;
  }

  #controls {
    margin: 20px;
  }

  button {
    padding: 6px 12px;
    font-size: 16px;
  }

  #timeline-container {
    width: 100%;
    height: 300px;
    overflow-x: auto;
    overflow-y: hidden;
    border-top: 1px solid #aaa;
    border-bottom: 1px solid #aaa;
    background: white;
    cursor: grab;
    position: relative;
  }

  #timeline {
    position: relative;
    height: 100%;
  }

  .tick {
    position: absolute;
    width: 1px;
    background: #000;
    bottom: 0;
    height: 60px;
  }

  .tick-year {
    position: absolute;
    bottom: 20px;
    transform: translateX(-50%);
    font-size: 12px;
    white-space: nowrap;
    z-index: 1;
  }

  .event {
    position: absolute;
    font-size: 12px;
    white-space: nowrap;
    background: #eee;
    padding: 2px 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
    z-index: 2;
  }

  .arrow.up {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-bottom: 6px solid #333;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="zoom-in">Zoom In +</button>
  <button id="zoom-out">Zoom Out -</button>
</div>

<div id="timeline-container">
  <div id="timeline"></div>
</div>

<script id="timeline-config" type="application/json">
{
  "startYear": 0,
  "endYear": 900,
  "events": [
    { "year": 100, "label": "Battle of Something" },
    { "year": 102, "label": "Coronation" },
    { "year": 105, "label": "Treaty Signed" },
    { "year": 400, "label": "Great Discovery" },
    { "year": 800, "label": "Mysterious Event" },
    { "year": 801, "label": "Close Event" },
    { "year": 802, "label": "Close Again" }
  ]
}
</script>

<script>
const config = JSON.parse(document.getElementById('timeline-config').textContent);
const startYear = config.startYear;
const endYear = config.endYear;
const events = config.events;

const container = document.getElementById('timeline-container');
const timeline = document.getElementById('timeline');
const zoomIn = document.getElementById('zoom-in');
const zoomOut = document.getElementById('zoom-out');

let basePixelsPerYear = 1; // will scale to fit container initially
let zoomLevel = 1;
const maxZoom = 10;
const minZoom = 0.01;

// Initialize timeline width to fit first and last year with equal margins
function initBasePixels() {
  basePixelsPerYear = (container.clientWidth * 0.9) / (endYear - startYear); 
}

function getPixelsPerYear() {
  return basePixelsPerYear * zoomLevel;
}

// Render the timeline
function renderTimeline() {
  timeline.innerHTML = '';
  const ppy = getPixelsPerYear();
  const totalYears = endYear - startYear;
  const sideMargin = container.clientWidth * 0.05; // 5% margin left and right
  const width = ppy * totalYears + sideMargin * 2;
  timeline.style.width = width + 'px';

  // Draw ticks
  let step = 1;
  if (zoomLevel < 0.3) step = 100;
  else if (zoomLevel < 1) step = 10;

  for (let y = startYear; y <= endYear; y++) {
    if (y % step !== 0 && y !== startYear && y !== endYear) continue;
    const x = sideMargin + (y - startYear) * ppy;

    const tick = document.createElement('div');
    tick.className = 'tick';
    tick.style.left = x + 'px';
    timeline.appendChild(tick);

    const label = document.createElement('div');
    label.className = 'tick-year';
    label.textContent = y;
    label.style.left = x + 'px';
    timeline.appendChild(label);
  }

  // Stack events vertically when close
  const eventPositions = {};
  events.forEach(e => {
    const x = sideMargin + (e.year - startYear) * ppy;
    const key = Math.round(x / 20); // group events within 20px horizontally
    if (!eventPositions[key]) eventPositions[key] = [];
    eventPositions[key].push(e);
  });

  Object.entries(eventPositions).forEach(([_, eventList]) => {
    eventList.forEach((e, i) => {
      const x = sideMargin + (e.year - startYear) * ppy;
      const el = document.createElement('div');
      el.className = 'event';
      el.textContent = e.label;
      el.style.left = x + 'px';
      el.style.transform = 'translateX(-50%)';
      el.style.bottom = (80 + i * 26) + 'px';
      const arrow = document.createElement('div');
      arrow.className = 'arrow up';
      el.appendChild(arrow);
      timeline.appendChild(el);
    });
  });
}

// Zoom function
function zoom(factor, centerX = null) {
  const oldZoom = zoomLevel;
  zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel * factor));
  if (centerX === null) centerX = container.clientWidth / 2;
  const scrollLeft = container.scrollLeft;
  const offsetX = scrollLeft + centerX;
  const yearAtCenter = (offsetX - container.clientWidth * 0.05) / (basePixelsPerYear * oldZoom) + startYear;
  const newOffsetX = (yearAtCenter - startYear) * getPixelsPerYear() + container.clientWidth * 0.05;
  renderTimeline();
  container.scrollLeft = newOffsetX - centerX;
}

// Event listeners
zoomIn.addEventListener('click', () => zoom(1.5));
zoomOut.addEventListener('click', () => zoom(1 / 1.5));
container.addEventListener('wheel', e => {
  if (e.ctrlKey || e.metaKey) return;
  e.preventDefault();
  zoom(e.deltaY < 0 ? 1.2 : 1 / 1.2, e.clientX - container.getBoundingClientRect().left);
});

// Dragging
let isDragging = false;
let startX, startScroll;
container.addEventListener('mousedown', e => {
  isDragging = true;
  startX = e.clientX;
  startScroll = container.scrollLeft;
  container.style.cursor = 'grabbing';
});
document.addEventListener('mouseup', () => {
  isDragging = false;
  container.style.cursor = 'grab';
});
document.addEventListener('mousemove', e => {
  if (isDragging) container.scrollLeft = startScroll - (e.clientX - startX);
});

// Initialize
window.addEventListener('resize', () => {
  initBasePixels();
  renderTimeline();
});
window.addEventListener('load', () => {
  initBasePixels();
  renderTimeline();
  container.scrollLeft = 0; // start at first year aligned to left
});
</script>

</body>
</html>
