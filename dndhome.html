<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zoomable Timeline (Fixed)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      margin: 20px;
    }

    button {
      padding: 6px 12px;
      font-size: 16px;
    }

    #timeline-container {
      width: 100%;
      height: 300px;
      overflow: hidden;
      border-top: 1px solid #aaa;
      border-bottom: 1px solid #aaa;
      position: relative;
      background: white;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #timeline {
      position: relative;
      height: 100%;
    }

    .tick {
      position: absolute;
      width: 1px;
      background-color: #000;
      bottom: 0;
      height: 60px;
    }

    .tick-year {
      position: absolute;
      bottom: 90px; /* Raised higher so not covered by events */
      transform: translateX(-50%);
      font-size: 12px;
      white-space: nowrap;
      z-index: 2;
    }

    .event {
      position: absolute;
      font-size: 12px;
      white-space: nowrap;
      background: #eee;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      z-index: 1;
    }

    .arrow.down {
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid #333;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
    }
  </style>
</head>
<body>

<div id="controls">
  <button id="zoom-in">Zoom In +</button>
  <button id="zoom-out">Zoom Out -</button>
</div>

<div id="timeline-container">
  <div id="timeline"></div>
</div>

<script id="timeline-config" type="application/json">
{
  "startYear": 0,
  "endYear": 900,
  "events": [
    { "year": 100, "label": "Battle of Something" },
    { "year": 102, "label": "Coronation" },
    { "year": 105, "label": "Treaty Signed" },
    { "year": 400, "label": "Great Discovery" },
    { "year": 800, "label": "Mysterious Event" },
    { "year": 801, "label": "Close Event" },
    { "year": 802, "label": "Close Again" }
  ]
}
</script>

<script>
  const config = JSON.parse(document.getElementById('timeline-config').textContent);
  const startYear = config.startYear ?? 0;
  const endYear = config.endYear ?? 900;
  const events = config.events ?? [];

  const container = document.getElementById('timeline-container');
  const timeline = document.getElementById('timeline');
  const zoomIn = document.getElementById('zoom-in');
  const zoomOut = document.getElementById('zoom-out');

  const basePixelsPerYear = 20;
  let zoomLevel = 1;
  const maxZoom = 10;
  const minZoom = 0.02;
  let isDragging = false;
  let dragStartX = 0;
  let scrollStart = 0;

  function getPixelsPerYear() {
    return basePixelsPerYear * zoomLevel;
  }

  function renderTimeline() {
    timeline.innerHTML = '';

    const ppy = getPixelsPerYear();
    const sidePadding = container.offsetWidth / 2;
    const totalYears = endYear - startYear;
    const width = ppy * totalYears + container.offsetWidth; // ensures equal margins both sides

    timeline.style.width = width + 'px';

    // Adjust tick step depending on zoom
    let step = 1;
    if (zoomLevel < 0.3) step = 100;
    else if (zoomLevel < 1) step = 10;

    for (let year = startYear; year <= endYear; year++) {
      if (year % step !== 0 && year !== startYear && year !== endYear) continue;

      const x = sidePadding + (year - startYear) * ppy;

      const tick = document.createElement('div');
      tick.className = 'tick';
      tick.style.left = x + 'px';
      timeline.appendChild(tick);

      const label = document.createElement('div');
      label.className = 'tick-year';
      label.textContent = year;
      label.style.left = x + 'px';
      timeline.appendChild(label);
    }

    // Group and space events vertically
    const eventSlots = {};
    events.forEach(e => {
      const pos = Math.round((e.year - startYear) * ppy);
      if (!eventSlots[pos]) eventSlots[pos] = [];
      eventSlots[pos].push(e);
    });

    Object.entries(eventSlots).forEach(([posStr, eventList]) => {
      const pos = parseInt(posStr);
      const baseX = sidePadding + pos;

      eventList.forEach((event, i) => {
        const el = document.createElement('div');
        el.className = 'event';
        el.textContent = event.label;
        el.style.left = baseX + 'px';
        el.style.transform = 'translateX(-50%)';

        const arrow = document.createElement('div');
        arrow.className = 'arrow down';

        const spacing = 26;
        const verticalOffset = 20 + i * spacing; // now lower, below tick labels
        el.style.bottom = verticalOffset + 'px';
        el.appendChild(arrow);
        timeline.appendChild(el);
      });
    });
  }

  function zoom(factor, centerX = null) {
    const oldZoom = zoomLevel;
    zoomLevel *= factor;
    zoomLevel = Math.min(Math.max(zoomLevel, minZoom), maxZoom);

    if (centerX === null) centerX = container.offsetWidth / 2;

    const scrollX = container.scrollLeft;
    const offsetX = scrollX + centerX;
    const yearAtCenter = startYear + (offsetX - container.offsetWidth / 2) / (basePixelsPerYear * oldZoom);
    const newOffsetX = (yearAtCenter - startYear) * basePixelsPerYear * zoomLevel + container.offsetWidth / 2;

    renderTimeline();
    container.scrollLeft = newOffsetX - centerX;
  }

  zoomIn.addEventListener('click', () => zoom(1.5));
  zoomOut.addEventListener('click', () => zoom(1 / 1.5));

  // Wheel zoom
  container.addEventListener('wheel', e => {
    if (e.ctrlKey || e.metaKey) return;
    e.preventDefault();
    zoom(e.deltaY < 0 ? 1.2 : 1 / 1.2, e.clientX - container.getBoundingClientRect().left);
  });

  // Dragging
  container.addEventListener('mousedown', e => {
    isDragging = true;
    dragStartX = e.clientX;
    scrollStart = container.scrollLeft;
    container.style.cursor = 'grabbing';
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    container.style.cursor = 'grab';
  });

  document.addEventListener('mousemove', e => {
    if (isDragging) {
      const dx = e.clientX - dragStartX;
      container.scrollLeft = Math.max(0, Math.min(timeline.scrollWidth - container.clientWidth, scrollStart - dx));
    }
  });

  window.addEventListener('load', () => {
    renderTimeline();
    container.scrollLeft = (timeline.scrollWidth - container.clientWidth) / 2;
  });

  window.addEventListener('resize', renderTimeline);
</script>

</body>
</html>
