<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Huvudsida</title>

    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/movie-styles.css">

    <script src="/scripts/text-resizer.js"></script>
</head>

<body>
    
    <div id="top-bar"></div>
    <script src="/scripts/scriptforall.js"></script>

    <p>The great hero Odo @(Odo Orgulas) once fought alongside Hektor@(Hektor Kostos) in the old wars.</p>


    <h1>
        Filmrecensioner
    </h1>


    <div class="sort-holder-wrapper">
    <!--Sort holder-->
    <div class="sort-holder">
        <select id="sort-select">
            <option value="title">Titel</option>
            <option value="release">Release</option>
            <option value="rating">Betyg</option>
            <option value="seen-date">Datum Sedd</option>
        </select>

        <button id="sort-direction-toggle" style="margin-left: 8px;">Asc â†‘</button>

        <div id="reviewer-filters">
            <input type="checkbox" id="Alvin" value="Alvin">
            <label for="Alvin">Alvin</label>
        
            <input type="checkbox" id="Diaa" value="Diaa">
            <label for="Diaa">Diaa</label>

            <input type="checkbox" id="Holger" value="Holger">
            <label for="Holger">Holger</label>
        
            <input type="checkbox" id="Carl" value="Carl">
            <label for="Carl">Carl</label>
        </div>
    </div>
        <div id="movie-count-box">
            <div class="label">Filmer sedda:</div>
            <div class="number" id="movie-count-number">0</div>
        </div>
    </div>


<hr>
<br>


    <!-- This is where movies go -->
    <div id="reviews"></div>
    <script src="/scripts/movie-generator.js"></script>


<script>
fetch('/articles/pages.json')
  .then(res => res.json())
  .then(pages => {
    // Create lookup map (case-insensitive)
    const pageMap = {};
    for (const page of pages) {
      pageMap[page.name.toLowerCase()] = page.url;
    }

    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);

    // Regex explanation:
    // 1. Parenthesized display text + multi-word target: (Display Text)@(Target Name)
    // 2. Single word display text + multi-word target: Word@(Target Name) or Word @(Target Name)
    // 3. Single word display text + single-word target: Word@Target or Word @Target
    const pattern = /\(([^\)]+)\)@\(([^\)]+)\)|(\b[A-Za-z0-9_\-]+)@\(([^\)]+)\)|(\b[A-Za-z0-9_\-]+)\s*@([A-Za-z0-9_\-]+)|(\b[A-Za-z0-9_\-]+)@([A-Za-z0-9_\-]+)/g;

    for (const node of nodes) {
      const text = node.textContent;
      if (!text.includes('@')) continue;

      const newHtml = text.replace(pattern, (match, dispParen, targetParen1, dispWordMulti, targetParen2, dispWordSingle, targetSingle1, dispWordSingleNoSpace, targetSingle2) => {
        const targetName = (targetParen1 || targetParen2 || targetSingle1 || targetSingle2 || '').trim();
        const key = targetName.toLowerCase();
        const url = pageMap[key];
        if (!url) return match;

        const displayText = (dispParen || dispWordMulti || dispWordSingle || dispWordSingleNoSpace || '').trim();
        return `<a href="${url}">${displayText}</a>`;
      });

      if (newHtml !== text) {
        const span = document.createElement('span');
        span.innerHTML = newHtml;
        node.parentNode.replaceChild(span, node);
      }
    }
  })
  .catch(err => console.error('Error loading pages.json', err));
</script>

</body>
</html>